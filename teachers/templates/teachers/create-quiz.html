{% extends 'teachers/partials/base.html' %}

{% load widget_tweaks %}

{% load static %}

{% block content %}

<div class="relative flex min-h-screen w-full flex-col">
  {% include 'teachers/partials/header.html' %}
  <main class="flex-1 px-4 py-8 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-3xl">
      <div class="mb-8">
        <h2 class="text-3xl font-bold tracking-tight">Create a New Quiz</h2>
        <p class="text-placeholder-light dark:text-placeholder-dark mt-1">Fill in the details to create a new quiz for
          your students.</p>
      </div>
      {% if messages %}
        <div class="messages mb-4">
          {% for message in messages %}
            <div class="p-4 mb-4 {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %} rounded">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
      <form method="post" class="space-y-6" >
        {% csrf_token %}
        <div
          class="rounded-lg border border-border-light dark:border-border-dark bg-gray-200 p-6">
          <h3 class="text-lg font-semibold mb-4">Quiz Details</h3>
          <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div class="sm:col-span-2">
              <label class="block text-sm font-medium" for="{{ form.title.id_for_label }}">Quiz Title</label>
              {{ form.title|add_class:"mt-1 block w-full rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary" }}
              {% if form.title.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.title.errors.0 }}</p>
              {% endif %}
            </div>
            <div class="sm:col-span-2">
              <label class="block text-sm font-medium" for="{{ form.description.id_for_label }}">Instructions</label>
              {{ form.description|add_class:"mt-1 block w-full rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary" }}
              {% if form.description.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
              {% endif %}
            </div>
            <div>
              <label class="block text-sm font-medium" for="{{ form.teacher_subject_class.id_for_label }}">Subject and Class</label>
              {{ form.teacher_subject_class|add_class:"mt-1 block w-full rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark focus:border-primary focus:ring-primary" }}
              {% if form.teacher_subject_class.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.teacher_subject_class.errors.0 }}</p>
              {% endif %}
            </div>
            <div>
              <label class="block text-sm font-medium" for="{{ form.duration.id_for_label }}">Duration (minutes)</label>
              {{ form.duration|add_class:"mt-1 block w-full rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary" }}
              {% if form.duration.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.duration.errors.0 }}</p>
              {% endif %}
            </div>
            <div>
              <label class="block text-sm font-medium" for="{{ form.start_date.id_for_label }}">Start Date</label>
              {{ form.start_date|add_class:"mt-1 block w-full rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark focus:border-primary focus:ring-primary" }}
              {% if form.start_date.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.start_date.errors.0 }}</p>
              {% endif %}
            </div>
            <div>
              <label class="block text-sm font-medium" for="{{ form.due_date.id_for_label }}">Due Date</label>
              {{ form.due_date|add_class:"mt-1 block w-full rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark focus:border-primary focus:ring-primary" }}
              {% if form.due_date.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.due_date.errors.0 }}</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div id="questions-container">
          <div class="question-section rounded-lg border border-border-light bg-gray-200 p-6 mb-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">Question 1</h3>
            </div>
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium">Question Text</label>
                <textarea
                  name="question_text[]"
                  class="mt-1 block w-full rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
                  placeholder="Enter the question text..." rows="3" required></textarea>
              </div>
              <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                  <label class="block text-sm font-medium">Option A</label>
                  <div class="flex items-center gap-2">
                    <input
                      type="text"
                      name="choice_text[]"
                      class="mt-1 flex-1 rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
                      placeholder="Enter option A" required />
                    <input type="checkbox" name="is_correct[]" value="0" class="h-4 w-4 text-primary focus:ring-primary" title="Mark as correct answer"/>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium">Option B</label>
                  <div class="flex items-center gap-2">
                    <input
                      type="text"
                      name="choice_text[]"
                      class="mt-1 flex-1 rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
                      placeholder="Enter option B" required />
                    <input type="checkbox" name="is_correct[]" value="1" class="h-4 w-4 text-primary focus:ring-primary" title="Mark as correct answer"/>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium">Option C</label>
                  <div class="flex items-center gap-2">
                    <input
                      type="text"
                      name="choice_text[]"
                      class="mt-1 flex-1 rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
                      placeholder="Enter option C" required />
                    <input type="checkbox" name="is_correct[]" value="2" class="h-4 w-4 text-primary focus:ring-primary" title="Mark as correct answer"/>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium">Option D</label>
                  <div class="flex items-center gap-2">
                    <input
                      type="text"
                      name="choice_text[]"
                      class="mt-1 flex-1 rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
                      placeholder="Enter option D" required />
                    <input type="checkbox" name="is_correct[]" value="3" class="h-4 w-4 text-primary focus:ring-primary" title="Mark as correct answer"/>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-between">
          <button type="button" id="add-question"
            class="flex items-center justify-center rounded-lg h-10 px-4 bg-primary/20 text-primary hover:bg-primary/30 dark:bg-primary/20 dark:hover:bg-primary/30 text-sm font-bold">
            <span class="material-symbols-outlined mr-2">add</span>
            <span>Add Question</span>
          </button>
          <div class="flex gap-4">
            <button type="submit"
              class="flex items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90">
              <span>Create Quiz</span>
            </button>
          </div>
        </div>
      </form>
      </div>
    </div>
  </main>
</div>

<!-- Template for new question section -->
<template id="question-template">
  <div class="question-section rounded-lg border border-border-light dark:border-border-dark bg-content-light dark:bg-content-dark p-6 mb-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Question {number}</h3>
      <button type="button" class="remove-question text-red-600 hover:text-red-800">
        <span class="material-symbols-outlined">delete</span>
      </button>
    </div>
    <div class="space-y-6">
      <div>
        <label class="block text-sm font-medium">Question Text</label>
        <textarea
          name="question_text[]"
          class="mt-1 block w-full rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
          placeholder="Enter the question text..." rows="3" required></textarea>
      </div>
      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="block text-sm font-medium">Option A</label>
          <div class="flex items-center gap-2">
            <input
              type="text"
              name="choice_text[]"
              class="mt-1 flex-1 rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
              placeholder="Enter option A" required />
            <input type="checkbox" name="is_correct[]" value="{optionA}" class="h-4 w-4 text-primary focus:ring-primary" title="Mark as correct answer"/>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Option B</label>
          <div class="flex items-center gap-2">
            <input
              type="text"
              name="choice_text[]"
              class="mt-1 flex-1 rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
              placeholder="Enter option B" required />
            <input type="checkbox" name="is_correct[]" value="{optionB}" class="h-4 w-4 text-primary focus:ring-primary" title="Mark as correct answer"/>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Option C</label>
          <div class="flex items-center gap-2">
            <input
              type="text"
              name="choice_text[]"
              class="mt-1 flex-1 rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
              placeholder="Enter option C" required />
            <input type="checkbox" name="is_correct[]" value="{optionC}" class="h-4 w-4 text-primary focus:ring-primary" title="Mark as correct answer"/>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Option D</label>
          <div class="flex items-center gap-2">
            <input
              type="text"
              name="choice_text[]"
              class="mt-1 flex-1 rounded border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark placeholder:text-placeholder-light dark:placeholder:text-placeholder-dark focus:border-primary focus:ring-primary"
              placeholder="Enter option D" required />
            <input type="checkbox" name="is_correct[]" value="{optionD}" class="h-4 w-4 text-primary focus:ring-primary" title="Mark as correct answer"/>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('questions-container');
    const addButton = document.getElementById('add-question');
    const template = document.getElementById('question-template');
    let questionCount = 1;

    // Function to update question numbers
    function updateQuestionNumbers() {
      container.querySelectorAll('.question-section').forEach((section, index) => {
        section.querySelector('h3').textContent = `Question ${index + 1}`;
      });
    }

    // Add new question
    addButton.addEventListener('click', () => {
      questionCount++;
      const baseIndex = (questionCount - 1) * 4;
      const newQuestion = template.content.cloneNode(true);
      
      // Update template placeholders
      const html = newQuestion.firstElementChild.innerHTML
        .replace('{number}', questionCount)
        .replace('{optionA}', baseIndex)
        .replace('{optionB}', baseIndex + 1)
        .replace('{optionC}', baseIndex + 2)
        .replace('{optionD}', baseIndex + 3);
      
      const div = document.createElement('div');
      div.className = 'question-section rounded-lg border border-border-light dark:border-border-dark bg-gray-200 dark:bg-content-dark p-6 mb-4';
      div.innerHTML = html;
      
      container.appendChild(div);

      // Add remove button functionality
      const removeBtn = div.querySelector('.remove-question');
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          div.remove();
          questionCount--;
          updateQuestionNumbers();
        });
      }
    });

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
      const questions = document.querySelectorAll('.question-section');
      let valid = true;

      questions.forEach(question => {
        const checkboxes = question.querySelectorAll('input[type="checkbox"]');
        const checked = Array.from(checkboxes).some(cb => cb.checked);
        if (!checked) {
          e.preventDefault();
          valid = false;
        }
      });

      if (!valid) {
        alert('Each question must have at least one correct answer selected.');
      }
    });
  });
</script>
{% endblock %}

{% endblock %}