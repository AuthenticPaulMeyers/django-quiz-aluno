{% extends 'students/base.html' %}

{% load widget_tweaks %}

{% load static %}

{% block content %}
  <div class="flex flex-col min-h-screen">
    {% include 'students/partials/student-header.html' %}
    <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="flex flex-row justify-between">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-8">
        <h2 class="text-3xl font-bold text-background-dark dark:text-background-light">
          All Quizzes
        </h2>
      </div>
      <div class="flex flex-row flex-wrap gap-2 mb-8 text-center align-center justify-center">
        <button data-filter="all"
          class="js-filter-btn flex items-center gap-1 px-4 py-2 rounded-lg bg-primary text-white text-sm font-medium transition-colors" aria-pressed="true">
          <span>All</span>
        </button>
        <button data-filter="active"
          class="js-filter-btn flex items-center gap-1 px-4 py-2 rounded-lg bg-background-light dark:bg-background-dark border border-background-dark/10 dark:border-background-light/10 text-background-dark/80 dark:text-background-light/80 hover:bg-primary/10 dark:hover:bg-primary/20 text-sm font-medium transition-colors">
          <span>Active</span>
        </button>
        <button data-filter="expired"
          class="js-filter-btn flex items-center gap-1 px-4 py-2 rounded-lg bg-background-light dark:bg-background-dark border border-background-dark/10 dark:border-background-light/10 text-background-dark/80 dark:text-background-light/80 hover:bg-primary/10 dark:hover:bg-primary/20 text-sm font-medium transition-colors">
          <span>Expired</span>
        </button>
        <button data-filter="upcoming"
          class="js-filter-btn flex items-center gap-1 px-4 py-2 rounded-lg bg-background-light dark:bg-background-dark border border-background-dark/10 dark:border-background-light/10 text-background-dark/80 dark:text-background-light/80 hover:bg-primary/10 dark:hover:bg-primary/20 text-sm font-medium transition-colors">
          <span>Upcoming</span>
        </button>
      </div>
      </div>
      <div
        class="bg-background-light dark:bg-background-dark/80 rounded-xl overflow-hidden border border-background-dark/10 dark:border-background-light/10">
        <div class="overflow-x-auto">
        {% if all_quizzes %}
          <table class="w-full text-sm text-left text-background-dark/80 dark:text-background-light/80">
            <thead
              class="text-xs uppercase bg-background-light dark:bg-background-dark border-b border-background-dark/10 dark:border-background-light/10">
              <tr>
                <th class="px-6 py-3 font-medium" scope="col">Quiz Title</th>
                <th class="px-6 py-3 font-medium" scope="col">Subject</th>
                <th class="px-6 py-3 font-medium" scope="col">Time allowed</th>
                <th class="px-6 py-3 font-medium text-center" scope="col">
                  Status
                </th>
                <th class="px-6 py-3 font-medium text-right" scope="col">
                  Actions
                </th>
              </tr>
            </thead>
            
            <tbody>
              {% for quiz in all_quizzes %}
              <tr
                data-status="{% if quiz.due_date < current_time %}expired{% elif quiz.start_date > current_time %}upcoming{% else %}active{% endif %}"
                class="border-b border-background-dark/10 dark:border-background-light/10 hover:bg-primary/5 dark:hover:bg-primary/10">
                <td class="px-6 py-4">{{ quiz.title }}</td>
                <td class="px-6 py-4">{{ quiz.subject.name }}</td>
                <td class="px-6 py-4">{{ quiz.duration }} mins</td>
                <td class="px-6 py-4 text-center">
                  
                {% if quiz.due_date < current_time %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-200 text-red-500">Expired</span>
                {% elif quiz.start_date > current_time %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-200 text-blue-500">Upcoming</span>
                {% elif quiz.start_date <= current_time and current_time <= quiz.due_date %}
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-200 text-green-500">Active</span>
                {% endif %}
                </td>
                <td class="px-6 py-4 text-right">
                  <a class="font-medium text-primary hover:underline" href="{% url 'quiz:quiz-details' quiz.id %}">View</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
            {% endif %}
          </table>
        </div>
      </div>
      <script>
        // Quiz filter script
        (function(){
          const buttons = document.querySelectorAll('.js-filter-btn');
          const rows = document.querySelectorAll('table tbody tr[data-status]');

          function applyFilter(filter) {
            rows.forEach(r => {
              if (!filter || filter === 'all') {
                r.style.display = '';
                return;
              }
              const status = r.getAttribute('data-status');
              r.style.display = (status === filter) ? '' : 'none';
            });
          }

          buttons.forEach(b => {
            b.addEventListener('click', function(){
              // toggle active visual state
              buttons.forEach(btn => {
                btn.classList.remove('bg-primary','text-white');
                btn.classList.add('bg-background-light');
                btn.setAttribute('aria-pressed','false');
              });
              this.classList.add('bg-primary','text-white');
              this.classList.remove('bg-background-light');
              this.setAttribute('aria-pressed','true');

              const filter = this.getAttribute('data-filter');
              applyFilter(filter);
              // persist last filter
              try { localStorage.setItem('quizzesFilter', filter); } catch(e){}
            });
          });

          // apply persisted filter on load
          try{
            const saved = localStorage.getItem('quizzesFilter') || 'all';
            const btn = Array.from(buttons).find(b => b.getAttribute('data-filter') === saved);
            if (btn) btn.click(); else buttons[0].click();
          } catch(e){ buttons[0].click(); }
        })();
      </script>
          {% if messages %}
            {% for message in messages %}
                <p class="text-center text-sm text-gray-500 mb-4">{{ message }}</p>
            {% endfor %}
          {% endif %}
    </main>
  </div>
{% endblock %}